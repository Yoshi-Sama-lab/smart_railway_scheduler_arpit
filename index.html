<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Railway Scheduler - AI-Powered Train Optimization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .search-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .search-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        .btn-secondary:hover {
            background: #38a169;
        }
        .results-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .results-header h2 {
            color: #667eea;
        }
        .results-count {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
        }
        .train-card {
            background: #f8faff;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        .train-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .train-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .train-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        .train-number {
            color: #667eea;
            font-weight: 700;
        }
        .train-route {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            font-size: 1.1rem;
        }
        .route-arrow {
            color: #667eea;
        }
        .train-times {
            display: flex;
            gap: 30px;
            margin: 15px 0;
        }
        .time-info {
            text-align: center;
        }
        .time-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }
        .time-value {
            font-weight: 600;
            color: #2d3748;
        }
        .ml-predictions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .prediction-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .prediction-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .prediction-label {
            font-size: 11px;
            color: #718096;
        }
        .recommendation {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .rec-highly-recommended {
            background: #c6f6d5;
            color: #276749;
        }
        .rec-recommended {
            background: #bee3f8;
            color: #2b6cb0;
        }
        .rec-consider {
            background: #fef5e7;
            color: #975a16;
        }
        .rec-caution {
            background: #fed7d7;
            color: #c53030;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #718096;
        }
        .analytics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }
        .metric-label {
            color: #718096;
            font-size: 14px;
        }
        .error-display {
            text-align: center;
            padding: 40px;
            color: #e53e3e;
            background: #fed7d7;
            border-radius: 10px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .analytics-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üöÑ Smart Railway Scheduler</h1>
            <p>AI-Powered Train Optimization with Real Indian Railways Data</p>
        </header>

        
        <div class="analytics-panel" id="analyticsPanel">
            <div class="metric-card">
                <div class="metric-value" id="totalTrains">10,580</div>
                <div class="metric-label">Total Trains</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalStations">8,697</div>
                <div class="metric-label">Total Stations</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgDelay">15</div>
                <div class="metric-label">Avg Predicted Delay (min)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">87.3%</div>
                <div class="metric-label">ML Model Accuracy</div>
            </div>
        </div>

        <div class="main-content">
            
            <div class="search-panel">
                <h2>üîç Search & Optimize</h2>
                
                
                <form id="searchForm">
                    <div class="form-group">
                        <label for="searchQuery">Search Trains</label>
                        <input type="text" id="searchQuery" 
                               placeholder="Train number, name, or route (e.g. 12001, Rajdhani, Ajmer)"
                               required>
                    </div>
                    <button type="submit" class="btn btn-primary">Search Trains</button>
                </form>

                
                <form id="routeForm" style="display: none;">
                    <div class="form-group">
                        <label for="fromStation">From Station</label>
                        <input type="text" id="fromStation" 
                               placeholder="Station code (e.g., NDLS)" required>
                    </div>
                    <div class="form-group">
                        <label for="toStation">To Station</label>
                        <input type="text" id="toStation" 
                               placeholder="Station code (e.g., BOM)" required>
                    </div>
                    <button type="submit" class="btn btn-secondary">Optimize Route</button>
                </form>

                <button type="button" class="btn btn-secondary" id="toggleBtn">
                    Route Optimization
                </button>
            </div>

            
            <div class="results-panel">
                <div class="results-header">
                    <h2 id="resultsTitle">Search Results</h2>
                    <span class="results-count" id="resultsCount" style="display: none;">0 trains</span>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <h3>Ready to Search</h3>
                        <p>Enter a train number, name, or route to get AI-powered optimization.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SmartRailwayUI {
            constructor() {
                this.init();
                this.loadAnalytics();
            }

            init() {
                this.searchForm = document.getElementById('searchForm');
                this.routeForm = document.getElementById('routeForm');
                this.toggleBtn = document.getElementById('toggleBtn');
                this.resultsContainer = document.getElementById('resultsContainer');
                this.resultsTitle = document.getElementById('resultsTitle');
                this.resultsCount = document.getElementById('resultsCount');
                
                this.currentMode = 'search';

                
                this.searchForm.addEventListener('submit', (e) => this.handleSearch(e));
                this.routeForm.addEventListener('submit', (e) => this.handleRouteOptimization(e));
                this.toggleBtn.addEventListener('click', () => this.toggleMode());
            }

            toggleMode() {
                if (this.currentMode === 'search') {
                    this.currentMode = 'route';
                    this.searchForm.style.display = 'none';
                    this.routeForm.style.display = 'block';
                    this.toggleBtn.textContent = 'Train Search';
                    this.resultsTitle.textContent = 'Route Optimization';
                } else {
                    this.currentMode = 'search';
                    this.searchForm.style.display = 'block';
                    this.routeForm.style.display = 'none';
                    this.toggleBtn.textContent = 'Route Optimization';
                    this.resultsTitle.textContent = 'Search Results';
                }
            }

            async handleSearch(event) {
                event.preventDefault();
                
                const query = document.getElementById('searchQuery').value.trim();
                if (!query) return;

                this.showLoading('Searching trains...');

                try {
                    console.log('Searching for:', query);
                    
                    const response = await fetch('/api/search-trains', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ search: query })
                    });

                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Search data received:', data);
                    
                    if (data.status === 'success') {
                        this.displayTrains(data.trains, `Search Results for "${query}"`);
                        this.updateResultsCount(data.count, data.performance?.total_trains_available);
                    } else {
                        this.showError(data.error || 'Search failed');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.showError(`Search error: ${error.message}`);
                }
            }

            async handleRouteOptimization(event) {
                event.preventDefault();
                
                const fromStation = document.getElementById('fromStation').value.trim().toUpperCase();
                const toStation = document.getElementById('toStation').value.trim().toUpperCase();
                
                if (!fromStation || !toStation) return;

                this.showLoading('Optimizing route...');

                try {
                    console.log('Optimizing route:', fromStation, '‚Üí', toStation);
                    
                    const response = await fetch('/api/optimize-route', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ 
                            from_station: fromStation, 
                            to_station: toStation 
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Route data received:', data);
                    
                    if (data.status === 'success') {
                        this.displayTrains(data.trains, `Optimized Route: ${data.route}`);
                        this.updateResultsCount(data.total_trains);
                    } else {
                        this.showError(data.error || data.message || 'Route optimization failed');
                    }
                } catch (error) {
                    console.error('Route optimization error:', error);
                    this.showError(`Route optimization error: ${error.message}`);
                }
            }

            displayTrains(trains, title) {
                this.resultsTitle.textContent = title;
                
                if (!trains || trains.length === 0) {
                    this.resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>No Trains Found</h3>
                            <p>Try a different search term or route.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                trains.forEach(train => {
                    html += this.createTrainCard(train);
                });

                this.resultsContainer.innerHTML = html;
            }

            createTrainCard(train) {
                const recommendationClass = `rec-${(train.recommendation || 'consider').toLowerCase().replace('_', '-')}`;
                const delayColor = (train.predicted_delay || 0) <= 5 ? '#48bb78' : 
                                  (train.predicted_delay || 0) <= 15 ? '#ed8936' : '#f56565';
                const scoreColor = (train.optimization_score || 0) > 0.8 ? '#48bb78' : 
                                  (train.optimization_score || 0) > 0.5 ? '#ed8936' : '#f56565';

                
                const trainName = train.train_name || 'Unknown Train';
                const trainNumber = train.train_number || 'N/A';
                const fromStation = train.from_station_name || train.from_station || 'N/A';
                const toStation = train.to_station_name || train.to_station || 'N/A';
                const departureTime = train.departure_time || 'N/A';
                const arrivalTime = train.arrival_time || 'N/A';
                const distance = train.distance_km || 0;
                const predictedDelay = train.predicted_delay || 0;
                const optimizationScore = (train.optimization_score || 0) * 100;
                const onTimeProbability = ((train.on_time_probability || train.confidence || 0.7) * 100);
                const recommendation = train.recommendation || 'CONSIDER';

                return `
                    <div class="train-card">
                        <div class="recommendation ${recommendationClass}">
                            ${recommendation}
                        </div>
                        
                        <div class="train-header">
                            <div class="train-info">
                                <h3>${trainName}</h3>
                                <div class="train-number">${trainNumber}</div>
                            </div>
                        </div>

                        <div class="train-route">
                            <span>${fromStation}</span>
                            <span class="route-arrow">‚Üí</span>
                            <span>${toStation}</span>
                        </div>

                        <div class="train-times">
                            <div class="time-info">
                                <div class="time-label">DEPARTURE</div>
                                <div class="time-value">${departureTime}</div>
                            </div>
                            <div class="time-info">
                                <div class="time-label">ARRIVAL</div>
                                <div class="time-value">${arrivalTime}</div>
                            </div>
                            <div class="time-info">
                                <div class="time-label">DISTANCE</div>
                                <div class="time-value">${distance} km</div>
                            </div>
                        </div>

                        <div class="ml-predictions">
                            <div class="prediction-item">
                                <div class="prediction-value" style="color: ${delayColor}">
                                    ${predictedDelay}min
                                </div>
                                <div class="prediction-label">Predicted Delay</div>
                            </div>
                            <div class="prediction-item">
                                <div class="prediction-value" style="color: ${scoreColor}">
                                    ${optimizationScore.toFixed(0)}%
                                </div>
                                <div class="prediction-label">Optimization Score</div>
                            </div>
                            <div class="prediction-item">
                                <div class="prediction-value" style="color: #667eea">
                                    ${onTimeProbability.toFixed(0)}%
                                </div>
                                <div class="prediction-label">On-Time Probability</div>
                            </div>
                            <div class="prediction-item">
                                <div class="prediction-value" style="color: #805ad5">
                                    ${train.train_type || 'EXPRESS'}
                                </div>
                                <div class="prediction-label">Train Type</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            updateResultsCount(count, total) {
                if (total) {
                    this.resultsCount.textContent = `${count} trains (from ${total.toLocaleString()} total)`;
                } else {
                    this.resultsCount.textContent = `${count} trains found`;
                }
                this.resultsCount.style.display = 'inline-block';
            }

            showLoading(message) {
                this.resultsContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
                this.resultsCount.style.display = 'none';
            }

            showError(message) {
                this.resultsContainer.innerHTML = `
                    <div class="error-display">
                        <h3>Error</h3>
                        <p>${message}</p>
                    </div>
                `;
                this.resultsCount.style.display = 'none';
            }

            async loadAnalytics() {
                try {
                    const response = await fetch('/api/analytics');
                    const data = await response.json();
                    
                    console.log('Analytics loaded:', data);
                    
                    if (data.status === 'success' && data.database_stats) {
                        document.getElementById('totalTrains').textContent = 
                            (data.database_stats.total_trains || 10580).toLocaleString();
                        document.getElementById('totalStations').textContent = 
                            (data.database_stats.total_stations || 8697).toLocaleString();
                    }
                } catch (error) {
                    console.log('Analytics loading failed:', error);
                }
            }
        }

        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Smart Railway UI...');
            new SmartRailwayUI();
        });
    </script>
</body>
</html>
